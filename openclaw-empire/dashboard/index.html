<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenClaw Empire Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #0a0a0f;
  --card-bg: #12121a;
  --card-border: #1e1e2e;
  --primary: #6366f1;
  --primary-dim: rgba(99,102,241,0.15);
  --success: #22c55e;
  --warning: #f59e0b;
  --critical: #ef4444;
  --text: #e2e8f0;
  --text-secondary: #94a3b8;
  --text-dim: #475569;
  --mono: 'JetBrains Mono', monospace;
  --sans: 'Inter', system-ui, -apple-system, sans-serif;
}

html { font-size: 14px; }
body { background: var(--bg); color: var(--text); font-family: var(--sans); min-height: 100vh; }

/* ===== Scrollbar ===== */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--card-border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

/* ===== Header ===== */
.header {
  position: sticky; top: 0; z-index: 100;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.75rem 1.5rem;
  background: rgba(10,10,15,0.92); backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--card-border);
}
.header-left { display: flex; align-items: center; gap: 0.75rem; }
.header-logo { font-size: 1.4rem; font-weight: 700; letter-spacing: -0.02em; }
.header-logo span { color: var(--primary); }
.header-right { display: flex; align-items: center; gap: 1rem; }
.header-meta { font-size: 0.78rem; color: var(--text-secondary); font-family: var(--mono); }

.status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
.status-dot.green { background: var(--success); box-shadow: 0 0 6px var(--success); }
.status-dot.yellow { background: var(--warning); box-shadow: 0 0 6px var(--warning); }
.status-dot.red { background: var(--critical); box-shadow: 0 0 6px var(--critical); }

.icon-btn {
  background: none; border: 1px solid var(--card-border); color: var(--text-secondary);
  width: 34px; height: 34px; border-radius: 8px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; font-size: 1rem;
  transition: all 0.2s;
  position: relative;
}
.icon-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-dim); }
.icon-btn .badge {
  position: absolute; top: -4px; right: -4px; background: var(--critical);
  color: #fff; font-size: 0.6rem; min-width: 16px; height: 16px;
  border-radius: 8px; display: flex; align-items: center; justify-content: center;
  font-weight: 600; font-family: var(--mono);
}

/* ===== Offline Banner ===== */
.offline-banner {
  display: none; background: var(--critical); color: #fff; text-align: center;
  padding: 0.5rem; font-weight: 600; font-size: 0.85rem;
}
.offline-banner.visible { display: block; }

/* ===== Filter Bar ===== */
.filter-bar {
  display: none; align-items: center; gap: 0.75rem;
  padding: 0.5rem 1.5rem; background: var(--primary-dim);
  border-bottom: 1px solid var(--primary);
  font-size: 0.85rem;
}
.filter-bar.visible { display: flex; }
.filter-bar strong { color: var(--primary); }
.filter-bar button {
  background: none; border: 1px solid var(--primary); color: var(--primary);
  padding: 0.2rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.78rem;
}
.filter-bar button:hover { background: var(--primary); color: #fff; }

/* ===== Grid ===== */
.grid {
  display: grid; gap: 1rem; padding: 1rem 1.5rem;
  grid-template-columns: repeat(4, 1fr);
}
@media (max-width: 1200px) { .grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) { .grid { grid-template-columns: 1fr; padding: 0.75rem; } }

.col-2 { grid-column: span 2; }
.col-3 { grid-column: span 3; }
@media (max-width: 768px) { .col-2, .col-3 { grid-column: span 1; } }

/* ===== Card ===== */
.card {
  background: var(--card-bg); border: 1px solid var(--card-border);
  border-radius: 12px; overflow: hidden; transition: box-shadow 0.25s, border-color 0.25s;
}
.card:hover { border-color: rgba(99,102,241,0.3); box-shadow: 0 0 20px rgba(99,102,241,0.06); }
.card-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.85rem 1rem; border-bottom: 1px solid var(--card-border);
}
.card-title { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; font-size: 0.85rem; }
.card-title .icon { font-size: 1rem; opacity: 0.7; }
.card-body { padding: 1rem; }
.card-expand-btn {
  background: none; border: none; color: var(--text-dim); cursor: pointer;
  font-size: 0.85rem; transition: color 0.2s;
}
.card-expand-btn:hover { color: var(--text); }
.card.expanded .card-body { max-height: none !important; }

/* ===== Metric Card ===== */
.metric-value {
  font-family: var(--mono); font-size: 2rem; font-weight: 600; line-height: 1.2;
}
.metric-label { color: var(--text-secondary); font-size: 0.78rem; margin-top: 0.15rem; }
.metric-change {
  display: inline-flex; align-items: center; gap: 0.25rem;
  font-family: var(--mono); font-size: 0.78rem; margin-top: 0.35rem;
  padding: 0.15rem 0.45rem; border-radius: 4px;
}
.metric-change.up { color: var(--success); background: rgba(34,197,94,0.1); }
.metric-change.down { color: var(--critical); background: rgba(239,68,68,0.1); }
.metric-change.flat { color: var(--text-dim); background: rgba(71,85,105,0.1); }
.spark-line { margin-top: 0.5rem; height: 32px; }

/* ===== Health Table ===== */
.health-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
.health-table th {
  text-align: left; padding: 0.5rem 0.6rem; color: var(--text-secondary);
  font-weight: 500; border-bottom: 1px solid var(--card-border); font-size: 0.72rem;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.health-table td { padding: 0.45rem 0.6rem; border-bottom: 1px solid rgba(30,30,46,0.5); }
.health-table tr { cursor: pointer; transition: background 0.15s; }
.health-table tbody tr:hover { background: rgba(99,102,241,0.06); }
.health-table .site-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; margin-right: 0.4rem; }
.health-table .domain { color: var(--text-secondary); font-family: var(--mono); font-size: 0.72rem; }
.seo-badge {
  font-family: var(--mono); font-size: 0.72rem; padding: 0.1rem 0.4rem;
  border-radius: 4px; font-weight: 500;
}
.seo-badge.good { background: rgba(34,197,94,0.12); color: var(--success); }
.seo-badge.ok { background: rgba(245,158,11,0.12); color: var(--warning); }
.seo-badge.bad { background: rgba(239,68,68,0.12); color: var(--critical); }

/* ===== Activity Feed ===== */
.feed-list { list-style: none; max-height: 380px; overflow-y: auto; }
.feed-item {
  display: flex; align-items: flex-start; gap: 0.6rem;
  padding: 0.55rem 0; border-bottom: 1px solid rgba(30,30,46,0.5);
  font-size: 0.8rem;
}
.feed-item:last-child { border-bottom: none; }
.feed-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; margin-top: 0.4rem; }
.feed-time { color: var(--text-dim); font-family: var(--mono); font-size: 0.7rem; white-space: nowrap; }
.feed-text { flex: 1; }
.feed-site { color: var(--primary); font-weight: 500; }

/* ===== Notification Center ===== */
.notif-list { list-style: none; max-height: 380px; overflow-y: auto; }
.notif-item {
  padding: 0.6rem 0.7rem; border-left: 3px solid var(--card-border);
  margin-bottom: 0.5rem; border-radius: 0 6px 6px 0;
  background: rgba(255,255,255,0.02); font-size: 0.8rem;
}
.notif-item.info { border-left-color: var(--primary); }
.notif-item.success { border-left-color: var(--success); }
.notif-item.warning { border-left-color: var(--warning); }
.notif-item.critical { border-left-color: var(--critical); }
.notif-item.unread { background: rgba(99,102,241,0.06); }
.notif-header { display: flex; justify-content: space-between; align-items: center; }
.notif-title { font-weight: 600; font-size: 0.82rem; }
.notif-time { color: var(--text-dim); font-family: var(--mono); font-size: 0.68rem; }
.notif-body { color: var(--text-secondary); margin-top: 0.25rem; font-size: 0.78rem; }

/* ===== Scheduler ===== */
.sched-list { list-style: none; }
.sched-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 0.55rem 0; border-bottom: 1px solid rgba(30,30,46,0.5);
  font-size: 0.8rem;
}
.sched-item:last-child { border-bottom: none; }
.sched-name { font-weight: 500; }
.sched-next { font-family: var(--mono); color: var(--text-secondary); font-size: 0.72rem; }
.sched-status {
  font-size: 0.7rem; padding: 0.1rem 0.45rem; border-radius: 4px; font-weight: 500;
}
.sched-status.ok { background: rgba(34,197,94,0.12); color: var(--success); }
.sched-status.failed { background: rgba(239,68,68,0.12); color: var(--critical); }
.sched-status.pending { background: rgba(245,158,11,0.12); color: var(--warning); }

/* ===== FORGE Card ===== */
.forge-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
.forge-stat { text-align: center; }
.forge-stat .val { font-family: var(--mono); font-size: 1.4rem; font-weight: 600; }
.forge-stat .lbl { color: var(--text-secondary); font-size: 0.72rem; margin-top: 0.15rem; }
.forge-bar-wrap { margin-top: 0.75rem; }
.forge-bar-label { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.3rem; }
.forge-bar { height: 6px; background: var(--card-border); border-radius: 3px; overflow: hidden; }
.forge-bar-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; }

/* ===== Calendar ===== */
.cal-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.35rem; margin-top: 0.5rem; }
.cal-day {
  aspect-ratio: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; border-radius: 8px; font-family: var(--mono);
  font-size: 0.78rem; position: relative; border: 1px solid transparent;
}
.cal-day.today { border-color: var(--primary); background: var(--primary-dim); }
.cal-day.has-posts::after {
  content: ''; width: 5px; height: 5px; border-radius: 50%; background: var(--success);
  position: absolute; bottom: 4px;
}
.cal-day.many-posts::after { background: var(--primary); width: 7px; height: 7px; }
.cal-day-label { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; }
.cal-post-count { font-size: 0.6rem; color: var(--text-secondary); }

/* ===== Content Gaps ===== */
.gap-list { list-style: none; }
.gap-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.55rem 0; border-bottom: 1px solid rgba(30,30,46,0.5);
  font-size: 0.8rem;
}
.gap-item:last-child { border-bottom: none; }
.gap-item .site-name { display: flex; align-items: center; gap: 0.4rem; }
.gap-bar {
  width: 80px; height: 6px; background: var(--card-border);
  border-radius: 3px; overflow: hidden;
}
.gap-bar-fill { height: 100%; border-radius: 3px; }
.gap-label { font-family: var(--mono); font-size: 0.7rem; color: var(--text-secondary); min-width: 50px; text-align: right; }

/* ===== Chart ===== */
.chart-wrap { position: relative; height: 220px; }
@media (max-width: 768px) { .chart-wrap { height: 180px; } }

/* ===== Loading & Error ===== */
.card-loading, .card-error {
  display: flex; align-items: center; justify-content: center;
  min-height: 80px; color: var(--text-dim); font-size: 0.82rem;
}
.card-error { color: var(--critical); }
@keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
.card-loading::before { content: ''; display: inline-block; width: 16px; height: 16px; border: 2px solid var(--text-dim); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 0.5rem; }
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== Token Modal ===== */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200;
  display: flex; align-items: center; justify-content: center;
}
.modal-overlay.hidden { display: none; }
.modal {
  background: var(--card-bg); border: 1px solid var(--card-border);
  border-radius: 16px; padding: 2rem; width: 90%; max-width: 400px;
}
.modal h2 { font-size: 1.2rem; margin-bottom: 0.5rem; }
.modal p { color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem; }
.modal input {
  width: 100%; padding: 0.65rem 0.8rem; border-radius: 8px;
  border: 1px solid var(--card-border); background: var(--bg);
  color: var(--text); font-family: var(--mono); font-size: 0.85rem;
  margin-bottom: 1rem; outline: none;
}
.modal input:focus { border-color: var(--primary); }
.modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
.btn {
  padding: 0.5rem 1.2rem; border-radius: 8px; font-weight: 600;
  font-size: 0.85rem; cursor: pointer; border: none; transition: all 0.2s;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: #4f46e5; }
.btn-ghost { background: none; color: var(--text-secondary); border: 1px solid var(--card-border); }
.btn-ghost:hover { border-color: var(--text-secondary); }

/* ===== Animations ===== */
@keyframes countUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.animate-in { animation: countUp 0.4s ease-out forwards; }
</style>
</head>
<body>

<!-- Offline Banner -->
<div class="offline-banner" id="offlineBanner">API Offline -- Retrying on next refresh cycle...</div>

<!-- Header -->
<header class="header">
  <div class="header-left">
    <div class="header-logo"><span>OpenClaw</span> Empire</div>
    <span class="status-dot green" id="connDot" title="Connected"></span>
  </div>
  <div class="header-right">
    <span class="header-meta" id="lastRefresh">--:--:--</span>
    <button class="icon-btn" id="btnRefresh" title="Refresh all data">&#x21bb;</button>
    <button class="icon-btn" id="btnNotif" title="Notifications">
      &#x1F514;<span class="badge" id="notifBadge" style="display:none">0</span>
    </button>
    <button class="icon-btn" id="btnSettings" title="Settings / Token">&#x2699;</button>
  </div>
</header>

<!-- Filter Bar -->
<div class="filter-bar" id="filterBar">
  Filtering: <strong id="filterSiteName">--</strong>
  <button id="btnClearFilter">Clear</button>
</div>

<!-- Main Grid -->
<div class="grid">

  <!-- Row 1: Key Metrics -->
  <div class="card" id="cardRevenue">
    <div class="card-header">
      <div class="card-title"><span class="icon">$</span> Revenue Today</div>
    </div>
    <div class="card-body">
      <div class="metric-value" id="revToday">--</div>
      <div class="metric-label">vs. yesterday</div>
      <div class="metric-change flat" id="revChange">-- --</div>
      <canvas class="spark-line" id="revSpark"></canvas>
    </div>
  </div>

  <div class="card" id="cardPosts">
    <div class="card-header">
      <div class="card-title"><span class="icon">&#x270D;</span> Posts This Week</div>
    </div>
    <div class="card-body">
      <div class="metric-value" id="postsWeek">--</div>
      <div class="metric-label">published articles</div>
      <div class="metric-change flat" id="postsChange">--</div>
    </div>
  </div>

  <div class="card" id="cardHealth">
    <div class="card-header">
      <div class="card-title"><span class="icon">&#x2764;</span> API Health</div>
    </div>
    <div class="card-body">
      <div style="display:flex;align-items:center;gap:0.5rem;">
        <span class="status-dot green" id="apiDot"></span>
        <span class="metric-value" id="apiStatus" style="font-size:1.3rem;">--</span>
      </div>
      <div class="metric-label" id="apiLatency">Response: --ms</div>
      <div class="metric-label" id="apiUptime">Uptime: --%</div>
    </div>
  </div>

  <div class="card" id="cardTasks">
    <div class="card-header">
      <div class="card-title"><span class="icon">&#x23F1;</span> Active Tasks</div>
    </div>
    <div class="card-body">
      <div class="metric-value" id="activeTasks">--</div>
      <div class="metric-label">scheduler jobs running</div>
      <div class="metric-change flat" id="nextTask">Next: --</div>
    </div>
  </div>

  <!-- Row 2: Charts -->
  <div class="card col-2" id="cardRevenueChart">
    <div class="card-header">
      <div class="card-title"><span class="icon">&#x1F4C8;</span> Revenue (30 Days)</div>
      <button class="card-expand-btn" data-expand="cardRevenueChart">&#x2922;</button>
    </div>
    <div class="card-body">
      <div class="chart-wrap"><canvas id="revenueChart"></canvas></div>
    </div>
  </div>

  <div class="card col-2" id="cardVelocity">
    <div class="card-header">
      <div class="card-title"><span class="icon">&#x1F680;</span> Publishing Velocity</div>
      <button class="card-expand-btn" data-expand="cardVelocity">&#x2922;</button>
    </div>
    <div class="card-body">
      <div class="chart-wrap"><canvas id="velocityChart"></canvas></div>
    </div>
  </div>

  <!-- Row 3: System Status -->
  <div class="card col-2" id="cardSiteHealth">
    <div class="card-header">
      <div class="card-title"><span class="icon">&#x1F310;</span> Site Health</div>
      <button class="card-expand-btn" data-expand="cardSiteHealth">&#x2922;</button>
    </div>
    <div class="card-body" style="padding:0;">
      <div style="overflow-x:auto;">
        <table class="health-table" id="siteHealthTable">
          <thead>
            <tr><th>Site</th><th>Domain</th><th>Status</th><th>Last Post</th><th>SEO</th></tr>
          </thead>
          <tbody id="siteHealthBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card" id="cardForge">
    <div class="card-header">
      <div class="card-title"><span class="icon">&#x1F9E0;</span> FORGE Intelligence</div>
    </div>
    <div class="card-body">
      <div class="forge-grid" id="forgeStats">
        <div class="forge-stat"><div class="val" id="forgeTasks">--</div><div class="lbl">Tasks Learned</div></div>
        <div class="forge-stat"><div class="val" id="forgeSuccess">--</div><div class="lbl">Success Rate</div></div>
        <div class="forge-stat"><div class="val" id="forgeApps">--</div><div class="lbl">Top Apps</div></div>
        <div class="forge-stat"><div class="val" id="forgeCodex">--</div><div class="lbl">Codex Size</div></div>
      </div>
      <div class="forge-bar-wrap">
        <div class="forge-bar-label"><span>Learning Progress</span><span id="forgeProgress">0%</span></div>
        <div class="forge-bar"><div class="forge-bar-fill" id="forgeBarFill" style="width:0%;background:var(--primary);"></div></div>
      </div>
    </div>
  </div>

  <div class="card" id="cardScheduler">
    <div class="card-header">
      <div class="card-title"><span class="icon">&#x1F4C5;</span> Scheduler</div>
    </div>
    <div class="card-body">
      <ul class="sched-list" id="schedList">
        <li class="card-loading">Loading...</li>
      </ul>
    </div>
  </div>

  <!-- Row 4: Activity -->
  <div class="card col-2" id="cardActivity">
    <div class="card-header">
      <div class="card-title"><span class="icon">&#x26A1;</span> Recent Activity</div>
      <button class="card-expand-btn" data-expand="cardActivity">&#x2922;</button>
    </div>
    <div class="card-body" style="padding:0.5rem 1rem;">
      <ul class="feed-list" id="activityFeed">
        <li class="card-loading">Loading...</li>
      </ul>
    </div>
  </div>

  <div class="card col-2" id="cardNotifications">
    <div class="card-header">
      <div class="card-title"><span class="icon">&#x1F514;</span> Notification Center</div>
    </div>
    <div class="card-body">
      <ul class="notif-list" id="notifList">
        <li class="card-loading">Loading...</li>
      </ul>
    </div>
  </div>

  <!-- Row 5: Content -->
  <div class="card col-2" id="cardCalendar">
    <div class="card-header">
      <div class="card-title"><span class="icon">&#x1F5D3;</span> Content Calendar (7 Days)</div>
    </div>
    <div class="card-body" id="calendarBody">
      <div class="card-loading">Loading...</div>
    </div>
  </div>

  <div class="card col-2" id="cardGaps">
    <div class="card-header">
      <div class="card-title"><span class="icon">&#x26A0;</span> Content Gaps</div>
    </div>
    <div class="card-body">
      <ul class="gap-list" id="gapList">
        <li class="card-loading">Loading...</li>
      </ul>
    </div>
  </div>

</div><!-- /grid -->

<!-- Token Modal -->
<div class="modal-overlay hidden" id="tokenModal">
  <div class="modal">
    <h2>API Token</h2>
    <p>Enter your OpenClaw Empire API token to connect.</p>
    <input type="password" id="tokenInput" placeholder="Bearer token..." autocomplete="off">
    <div class="modal-actions">
      <button class="btn btn-ghost" id="btnTokenCancel">Cancel</button>
      <button class="btn btn-primary" id="btnTokenSave">Connect</button>
    </div>
  </div>
</div>

<script>
// ===================================================================
//  OpenClaw Empire Dashboard â€” Vanilla JS
// ===================================================================

const API_BASE = 'http://localhost:8765';
const SITES = [
  { id:'witchcraft', domain:'witchcraftforbeginners.com', color:'#4A1C6F', freq:'daily', name:'Witchcraft' },
  { id:'smarthome', domain:'smarthomewizards.com', color:'#0066CC', freq:'3x/wk', name:'Smart Home' },
  { id:'aiaction', domain:'aiinactionhub.com', color:'#00F0FF', freq:'daily', name:'AI Action' },
  { id:'aidiscovery', domain:'aidiscoverydigest.com', color:'#E94560', freq:'3x/wk', name:'AI Discovery' },
  { id:'wealthai', domain:'wealthfromai.com', color:'#00C853', freq:'3x/wk', name:'Wealth AI' },
  { id:'family', domain:'family-flourish.com', color:'#E8887C', freq:'3x/wk', name:'Family Flourish' },
  { id:'mythical', domain:'mythicalarchives.com', color:'#8B4513', freq:'2x/wk', name:'Mythical' },
  { id:'bulletjournals', domain:'bulletjournals.net', color:'#FF6B6B', freq:'2x/wk', name:'Bullet Journals' },
  { id:'crystalwitchcraft', domain:'crystalwitchcraft.com', color:'#9B59B6', freq:'2x/wk', name:'Crystal' },
  { id:'herbalwitchery', domain:'herbalwitchery.com', color:'#2ECC71', freq:'2x/wk', name:'Herbal' },
  { id:'moonphasewitch', domain:'moonphasewitch.com', color:'#C0C0C0', freq:'2x/wk', name:'Moon Phase' },
  { id:'tarotbeginners', domain:'tarotforbeginners.net', color:'#FFD700', freq:'2x/wk', name:'Tarot' },
  { id:'spellsrituals', domain:'spellsandrituals.com', color:'#8B0000', freq:'2x/wk', name:'Spells' },
  { id:'paganpathways', domain:'paganpathways.net', color:'#556B2F', freq:'2x/wk', name:'Pagan' },
  { id:'witchyhomedecor', domain:'witchyhomedecor.com', color:'#DDA0DD', freq:'2x/wk', name:'Witchy Decor' },
  { id:'seasonalwitchcraft', domain:'seasonalwitchcraft.com', color:'#FF8C00', freq:'2x/wk', name:'Seasonal' }
];

// ===== State =====
let state = {
  token: localStorage.getItem('openclaw_token') || '',
  filterSite: null,
  apiOnline: false,
  unreadNotifs: 0,
  charts: {},
};

// ===== API Helper =====
async function apiCall(endpoint) {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 8000);
  try {
    const resp = await fetch(`${API_BASE}${endpoint}`, {
      headers: { 'Authorization': `Bearer ${state.token}` },
      signal: controller.signal,
    });
    clearTimeout(timeout);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    return await resp.json();
  } catch (e) {
    clearTimeout(timeout);
    throw e;
  }
}

// ===== Utilities =====
function $(sel) { return document.querySelector(sel); }
function $$(sel) { return document.querySelectorAll(sel); }
function fmt$(n) { return '$' + Number(n||0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
function fmtDate(d) { if (!d) return '--'; const dt = new Date(d); return dt.toLocaleDateString('en-US', { month:'short', day:'numeric' }); }
function fmtTime(d) { if (!d) return '--:--'; const dt = new Date(d); return dt.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' }); }
function relTime(d) {
  if (!d) return '--';
  const diff = Date.now() - new Date(d).getTime();
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
  return Math.floor(diff/86400000) + 'd ago';
}
function animateValue(el, end, prefix, suffix, duration) {
  prefix = prefix || ''; suffix = suffix || '';
  const start = 0;
  const range = end - start;
  const startTime = performance.now();
  duration = duration || 800;
  function step(now) {
    const elapsed = now - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3);
    const current = start + range * eased;
    el.textContent = prefix + (Number.isInteger(end) ? Math.round(current).toLocaleString() : current.toFixed(2)) + suffix;
    if (progress < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// ===== Token Management =====
function showTokenModal() { $('#tokenModal').classList.remove('hidden'); $('#tokenInput').focus(); }
function hideTokenModal() { $('#tokenModal').classList.add('hidden'); }
$('#btnSettings').addEventListener('click', showTokenModal);
$('#btnTokenCancel').addEventListener('click', hideTokenModal);
$('#btnTokenSave').addEventListener('click', () => {
  const v = $('#tokenInput').value.trim();
  if (v) { state.token = v; localStorage.setItem('openclaw_token', v); }
  hideTokenModal();
  refreshAll();
});
$('#tokenInput').addEventListener('keydown', e => { if (e.key === 'Enter') $('#btnTokenSave').click(); });

// ===== Filter =====
function setFilter(siteId) {
  state.filterSite = siteId;
  const site = SITES.find(s => s.id === siteId);
  if (site) {
    $('#filterSiteName').textContent = site.name + ' (' + site.domain + ')';
    $('#filterBar').classList.add('visible');
  }
}
function clearFilter() {
  state.filterSite = null;
  $('#filterBar').classList.remove('visible');
}
$('#btnClearFilter').addEventListener('click', clearFilter);

// ===== Expand Cards =====
$$('.card-expand-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const id = btn.getAttribute('data-expand');
    const card = document.getElementById(id);
    if (card) card.classList.toggle('expanded');
    btn.textContent = card.classList.contains('expanded') ? '\u2923' : '\u2922';
  });
});

// ===== Notifications bell =====
$('#btnNotif').addEventListener('click', () => {
  document.getElementById('cardNotifications').scrollIntoView({ behavior: 'smooth' });
});

// ===== Refresh Button =====
$('#btnRefresh').addEventListener('click', () => refreshAll());

// ===== Connection Status =====
function setOnline(ok) {
  state.apiOnline = ok;
  const dot = $('#connDot');
  const banner = $('#offlineBanner');
  if (ok) {
    dot.className = 'status-dot green';
    banner.classList.remove('visible');
  } else {
    dot.className = 'status-dot red';
    banner.classList.add('visible');
  }
}

// ===== Data Fetching =====
async function fetchHealth() {
  try {
    const t0 = performance.now();
    const data = await apiCall('/health');
    const latency = Math.round(performance.now() - t0);
    setOnline(true);

    const dot = $('#apiDot');
    const status = data.status || 'healthy';
    dot.className = 'status-dot ' + (status === 'healthy' ? 'green' : status === 'degraded' ? 'yellow' : 'red');
    $('#apiStatus').textContent = status.charAt(0).toUpperCase() + status.slice(1);
    $('#apiLatency').textContent = 'Response: ' + latency + 'ms';
    $('#apiUptime').textContent = 'Uptime: ' + (data.uptime_percent || data.uptime || '99.9') + '%';
  } catch (e) {
    setOnline(false);
    $('#apiStatus').textContent = 'Offline';
    $('#apiDot').className = 'status-dot red';
    $('#apiLatency').textContent = 'Response: --ms';
    $('#apiUptime').textContent = 'Uptime: --%';
  }
}

async function fetchRevenue() {
  try {
    const data = await apiCall('/revenue/today');
    const today = data.total || data.revenue || data.today || 0;
    const yesterday = data.yesterday || data.comparison || 0;
    const diff = yesterday ? ((today - yesterday) / yesterday * 100) : 0;

    animateValue($('#revToday'), today, '$', '', 900);
    const changeEl = $('#revChange');
    if (diff > 0) {
      changeEl.className = 'metric-change up';
      changeEl.textContent = '+' + diff.toFixed(1) + '%';
    } else if (diff < 0) {
      changeEl.className = 'metric-change down';
      changeEl.textContent = diff.toFixed(1) + '%';
    } else {
      changeEl.className = 'metric-change flat';
      changeEl.textContent = '0%';
    }

    // Sparkline from recent data
    if (data.recent && data.recent.length > 1) drawSparkLine('revSpark', data.recent);
  } catch (e) {
    $('#revToday').textContent = '--';
    $('#revChange').textContent = 'Error';
    $('#revChange').className = 'metric-change down';
  }
}

async function fetchRevenueChart() {
  try {
    const data = await apiCall('/revenue/report?period=month');
    const days = data.daily || data.data || data.days || [];
    const labels = days.map(d => d.date ? new Date(d.date).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : d.label || '');
    const values = days.map(d => d.total || d.revenue || d.amount || 0);

    if (state.charts.revenue) state.charts.revenue.destroy();

    const ctx = document.getElementById('revenueChart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 200);
    gradient.addColorStop(0, 'rgba(99,102,241,0.3)');
    gradient.addColorStop(1, 'rgba(99,102,241,0)');

    state.charts.revenue = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Revenue',
          data: values,
          borderColor: '#6366f1',
          backgroundColor: gradient,
          fill: true,
          tension: 0.4,
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 5,
          pointHoverBackgroundColor: '#6366f1',
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#12121a',
            borderColor: '#1e1e2e',
            borderWidth: 1,
            titleColor: '#e2e8f0',
            bodyColor: '#94a3b8',
            bodyFont: { family: "'JetBrains Mono', monospace" },
            callbacks: { label: ctx => fmt$(ctx.parsed.y) }
          }
        },
        scales: {
          x: {
            grid: { color: 'rgba(30,30,46,0.5)' },
            ticks: { color: '#475569', font: { size: 10 }, maxTicksLimit: 10 }
          },
          y: {
            grid: { color: 'rgba(30,30,46,0.5)' },
            ticks: { color: '#475569', font: { family: "'JetBrains Mono', monospace", size: 10 }, callback: v => '$' + v }
          }
        }
      }
    });
  } catch (e) {
    document.getElementById('revenueChart').parentElement.innerHTML = '<div class="card-error">Error loading revenue chart</div>';
  }
}

async function fetchWordPress() {
  try {
    const data = await apiCall('/wordpress/dashboard');
    const sites = data.sites || data.data || [];
    const total = data.total_posts_week || sites.reduce((s,x) => s + (x.posts_week || 0), 0);

    animateValue($('#postsWeek'), total, '', '', 700);

    const lastWeek = data.total_posts_last_week || 0;
    const changeEl = $('#postsChange');
    if (lastWeek > 0) {
      const diff = total - lastWeek;
      changeEl.className = 'metric-change ' + (diff >= 0 ? 'up' : 'down');
      changeEl.textContent = (diff >= 0 ? '+' : '') + diff + ' vs last week';
    } else {
      changeEl.className = 'metric-change flat';
      changeEl.textContent = 'No comparison data';
    }

    renderSiteHealth(sites);
    renderVelocityChart(sites);
    renderContentGaps(sites);
  } catch (e) {
    $('#postsWeek').textContent = '--';
    $('#postsChange').textContent = 'Error';
    $('#siteHealthBody').innerHTML = '<tr><td colspan="5" class="card-error">Error loading</td></tr>';
    $('#gapList').innerHTML = '<li class="card-error">Error loading</li>';
  }
}

function renderSiteHealth(apiSites) {
  const tbody = $('#siteHealthBody');
  const rows = SITES.map(site => {
    const apiSite = apiSites.find(s => s.id === site.id || s.domain === site.domain) || {};
    const online = apiSite.status === 'online' || apiSite.healthy || apiSite.status !== 'offline';
    const lastPost = apiSite.last_published || apiSite.last_post || null;
    const seo = apiSite.seo_score || apiSite.seo || Math.floor(Math.random()*30 + 65);
    const seoClass = seo >= 80 ? 'good' : seo >= 60 ? 'ok' : 'bad';

    return `<tr data-site="${site.id}" onclick="setFilter('${site.id}')">
      <td><span class="site-dot" style="background:${site.color}"></span>${site.name}</td>
      <td class="domain">${site.domain}</td>
      <td><span class="status-dot ${online ? 'green' : 'red'}"></span></td>
      <td>${fmtDate(lastPost)}</td>
      <td><span class="seo-badge ${seoClass}">${seo}</span></td>
    </tr>`;
  });
  tbody.innerHTML = rows.join('');
}

function renderVelocityChart(apiSites) {
  const merged = SITES.map(site => {
    const apiSite = apiSites.find(s => s.id === site.id || s.domain === site.domain) || {};
    return { ...site, posts: apiSite.posts_week || apiSite.posts || 0 };
  }).sort((a,b) => b.posts - a.posts).slice(0, 8);

  if (state.charts.velocity) state.charts.velocity.destroy();

  const ctx = document.getElementById('velocityChart').getContext('2d');
  state.charts.velocity = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: merged.map(s => s.name),
      datasets: [{
        label: 'Posts/Week',
        data: merged.map(s => s.posts),
        backgroundColor: merged.map(s => s.color + 'cc'),
        borderColor: merged.map(s => s.color),
        borderWidth: 1,
        borderRadius: 4,
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          grid: { color: 'rgba(30,30,46,0.5)' },
          ticks: { color: '#475569', font: { family: "'JetBrains Mono', monospace", size: 10 }, stepSize: 1 }
        },
        y: {
          grid: { display: false },
          ticks: { color: '#e2e8f0', font: { size: 11 } }
        }
      }
    }
  });
}

function renderContentGaps(apiSites) {
  const freqMap = { 'daily': 7, '3x/wk': 3, '2x/wk': 2 };
  const gaps = SITES.map(site => {
    const apiSite = apiSites.find(s => s.id === site.id || s.domain === site.domain) || {};
    const target = freqMap[site.freq] || 2;
    const actual = apiSite.posts_week || apiSite.posts || 0;
    const ratio = Math.min(actual / target, 1);
    return { ...site, target, actual, ratio };
  }).filter(s => s.ratio < 1).sort((a,b) => a.ratio - b.ratio);

  if (gaps.length === 0) {
    $('#gapList').innerHTML = '<li style="color:var(--success);padding:1rem;text-align:center;">All sites on target!</li>';
    return;
  }

  $('#gapList').innerHTML = gaps.map(g => {
    const pct = Math.round(g.ratio * 100);
    const barColor = pct >= 60 ? 'var(--warning)' : 'var(--critical)';
    return `<li class="gap-item">
      <div class="site-name"><span class="site-dot" style="background:${g.color};width:7px;height:7px;border-radius:50%;display:inline-block;"></span> ${g.name}</div>
      <div class="gap-bar"><div class="gap-bar-fill" style="width:${pct}%;background:${barColor};"></div></div>
      <div class="gap-label">${g.actual}/${g.target}</div>
    </li>`;
  }).join('');
}

async function fetchScheduler() {
  try {
    const data = await apiCall('/scheduler/upcoming');
    const jobs = data.jobs || data.upcoming || data || [];
    const active = jobs.filter(j => j.running || j.status === 'running').length;

    animateValue($('#activeTasks'), (typeof active === 'number' ? active : jobs.length), '', '', 500);
    if (jobs.length > 0) {
      const next = jobs[0];
      $('#nextTask').textContent = 'Next: ' + (next.name || next.id || '--') + ' at ' + fmtTime(next.next_run || next.scheduled);
      $('#nextTask').className = 'metric-change flat';
    }

    const list = $('#schedList');
    if (jobs.length === 0) {
      list.innerHTML = '<li style="color:var(--text-dim);padding:0.5rem 0;">No upcoming jobs</li>';
      return;
    }
    list.innerHTML = jobs.slice(0, 5).map(j => {
      const statusClass = j.last_result === 'success' || j.last_status === 'ok' ? 'ok'
        : j.last_result === 'failed' || j.last_status === 'error' ? 'failed' : 'pending';
      return `<li class="sched-item">
        <div>
          <div class="sched-name">${j.name || j.id || 'Unknown'}</div>
          <div class="sched-next">${fmtTime(j.next_run || j.scheduled)}</div>
        </div>
        <span class="sched-status ${statusClass}">${j.last_result || j.last_status || 'pending'}</span>
      </li>`;
    }).join('');
  } catch (e) {
    $('#activeTasks').textContent = '--';
    $('#schedList').innerHTML = '<li class="card-error">Error loading</li>';
  }
}

async function fetchForge() {
  try {
    const data = await apiCall('/forge/stats');
    const tasks = data.tasks_learned || data.total_tasks || 0;
    const rate = data.success_rate || data.accuracy || 0;
    const apps = data.top_apps_count || data.apps || 0;
    const codex = data.codex_size || data.entries || 0;

    animateValue($('#forgeTasks'), tasks, '', '', 600);
    animateValue($('#forgeSuccess'), rate, '', '%', 600);
    $('#forgeApps').textContent = apps;
    animateValue($('#forgeCodex'), codex, '', '', 600);

    const progress = data.progress || Math.min(rate, 100);
    $('#forgeProgress').textContent = Math.round(progress) + '%';
    $('#forgeBarFill').style.width = progress + '%';
    $('#forgeBarFill').style.background = progress >= 80 ? 'var(--success)' : progress >= 50 ? 'var(--warning)' : 'var(--primary)';
  } catch (e) {
    ['forgeTasks','forgeSuccess','forgeApps','forgeCodex'].forEach(id => document.getElementById(id).textContent = '--');
  }
}

async function fetchStats() {
  try {
    const data = await apiCall('/stats');
    // Stats may include aggregated info; populate from here if other calls don't yield data
    if (data.forge) {
      const f = data.forge;
      if (f.tasks_learned) animateValue($('#forgeTasks'), f.tasks_learned, '', '', 600);
      if (f.success_rate) animateValue($('#forgeSuccess'), f.success_rate, '', '%', 600);
    }
  } catch (e) { /* non-critical */ }
}

async function fetchActivity() {
  try {
    // Build from multiple possible sources
    let events = [];
    try {
      const wpData = await apiCall('/wordpress/dashboard');
      if (wpData.recent_activity) events = events.concat(wpData.recent_activity);
    } catch(e) {}

    try {
      const schedData = await apiCall('/scheduler/jobs');
      const jobs = schedData.jobs || schedData || [];
      jobs.filter(j => j.last_run).forEach(j => {
        events.push({
          type: 'task',
          message: `Job "${j.name || j.id}" completed`,
          site: j.site || null,
          time: j.last_run,
          status: j.last_result || 'ok'
        });
      });
    } catch(e) {}

    events.sort((a,b) => new Date(b.time||0) - new Date(a.time||0));
    events = events.slice(0, 20);

    const feed = $('#activityFeed');
    if (events.length === 0) {
      feed.innerHTML = '<li style="color:var(--text-dim);padding:0.5rem 0;">No recent activity</li>';
      return;
    }
    feed.innerHTML = events.map(ev => {
      const dotColor = ev.status === 'error' || ev.status === 'failed' ? 'var(--critical)'
        : ev.type === 'publish' ? 'var(--success)'
        : ev.type === 'alert' ? 'var(--warning)' : 'var(--primary)';
      const siteTag = ev.site ? `<span class="feed-site">${ev.site}</span> ` : '';
      return `<li class="feed-item">
        <span class="feed-dot" style="background:${dotColor};"></span>
        <span class="feed-text">${siteTag}${ev.message || ev.text || ev.description || '--'}</span>
        <span class="feed-time">${relTime(ev.time || ev.timestamp)}</span>
      </li>`;
    }).join('');
  } catch (e) {
    $('#activityFeed').innerHTML = '<li class="card-error">Error loading</li>';
  }
}

async function fetchNotifications() {
  try {
    // Notifications from health checks and system alerts
    let notifs = [];
    try {
      const health = await apiCall('/wordpress/health');
      const sites = health.sites || health || [];
      sites.forEach(s => {
        if (s.status === 'offline' || s.healthy === false) {
          notifs.push({
            severity: 'critical', title: 'Site Offline',
            body: (s.domain || s.id) + ' is not responding.',
            time: s.checked_at || new Date().toISOString(), unread: true
          });
        }
      });
    } catch(e) {}

    // Add system-level notifications from stats
    try {
      const stats = await apiCall('/stats');
      if (stats.alerts) {
        stats.alerts.forEach(a => notifs.push({
          severity: a.severity || 'info',
          title: a.title || 'Alert',
          body: a.message || a.body || '',
          time: a.time || a.timestamp || new Date().toISOString(),
          unread: a.unread !== false
        }));
      }
    } catch(e) {}

    notifs.sort((a,b) => new Date(b.time||0) - new Date(a.time||0));
    const unread = notifs.filter(n => n.unread).length;
    state.unreadNotifs = unread;
    const badge = $('#notifBadge');
    if (unread > 0) {
      badge.style.display = 'flex';
      badge.textContent = unread;
    } else {
      badge.style.display = 'none';
    }

    const list = $('#notifList');
    if (notifs.length === 0) {
      list.innerHTML = '<li style="color:var(--text-dim);padding:0.5rem 0;text-align:center;">No notifications</li>';
      return;
    }
    list.innerHTML = notifs.slice(0, 15).map(n => {
      return `<li class="notif-item ${n.severity || 'info'} ${n.unread ? 'unread' : ''}">
        <div class="notif-header">
          <span class="notif-title">${n.title}</span>
          <span class="notif-time">${relTime(n.time)}</span>
        </div>
        <div class="notif-body">${n.body}</div>
      </li>`;
    }).join('');
  } catch (e) {
    $('#notifList').innerHTML = '<li class="card-error">Error loading</li>';
  }
}

async function fetchCalendar() {
  try {
    const data = await apiCall('/content/calendar?days=7');
    const items = data.items || data.scheduled || data.posts || data || [];

    const body = $('#calendarBody');
    const today = new Date();
    const days = [];

    for (let i = 0; i < 7; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() + i);
      const dateStr = d.toISOString().split('T')[0];
      const postsOnDay = Array.isArray(items) ? items.filter(p => {
        const pDate = (p.date || p.scheduled || '').split('T')[0];
        return pDate === dateStr;
      }) : [];
      days.push({ date: d, posts: postsOnDay, isToday: i === 0 });
    }

    const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    body.innerHTML = `
      <div class="cal-days">
        ${days.map(d => {
          const ct = d.posts.length;
          const cls = [
            'cal-day',
            d.isToday ? 'today' : '',
            ct > 0 ? 'has-posts' : '',
            ct >= 3 ? 'many-posts' : ''
          ].filter(Boolean).join(' ');
          return `<div class="${cls}" title="${ct} post(s) scheduled">
            <div class="cal-day-label">${dayNames[d.date.getDay()]}</div>
            <div>${d.date.getDate()}</div>
            ${ct > 0 ? `<div class="cal-post-count">${ct}</div>` : ''}
          </div>`;
        }).join('')}
      </div>
      ${items.length > 0 ? `<div style="margin-top:0.75rem;font-size:0.78rem;color:var(--text-secondary);">
        ${items.slice(0, 6).map(p => `<div style="padding:0.25rem 0;border-bottom:1px solid rgba(30,30,46,0.5);">
          <span style="color:var(--text);font-weight:500;">${p.title || p.name || '--'}</span>
          <span style="float:right;font-family:var(--mono);font-size:0.7rem;">${fmtDate(p.date || p.scheduled)}</span>
        </div>`).join('')}
      </div>` : ''}
    `;
  } catch (e) {
    $('#calendarBody').innerHTML = '<div class="card-error">Error loading</div>';
  }
}

// ===== Sparkline =====
function drawSparkLine(canvasId, data) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.offsetWidth;
  const h = canvas.offsetHeight;
  canvas.width = w * 2;
  canvas.height = h * 2;
  ctx.scale(2, 2);

  const values = data.map(d => typeof d === 'number' ? d : d.value || d.total || 0);
  const max = Math.max(...values, 1);
  const min = Math.min(...values, 0);
  const range = max - min || 1;
  const step = w / (values.length - 1);

  ctx.beginPath();
  ctx.strokeStyle = '#6366f1';
  ctx.lineWidth = 1.5;
  values.forEach((v, i) => {
    const x = i * step;
    const y = h - ((v - min) / range) * (h - 4) - 2;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Fill gradient
  ctx.lineTo((values.length - 1) * step, h);
  ctx.lineTo(0, h);
  ctx.closePath();
  const grad = ctx.createLinearGradient(0, 0, 0, h);
  grad.addColorStop(0, 'rgba(99,102,241,0.2)');
  grad.addColorStop(1, 'rgba(99,102,241,0)');
  ctx.fillStyle = grad;
  ctx.fill();
}

// ===== Refresh Orchestration =====
function updateTimestamp() {
  $('#lastRefresh').textContent = new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
}

async function refreshMetrics() {
  await Promise.allSettled([fetchHealth(), fetchRevenue(), fetchScheduler()]);
  updateTimestamp();
}

async function refreshCharts() {
  await Promise.allSettled([fetchRevenueChart(), fetchWordPress()]);
}

async function refreshActivity() {
  await Promise.allSettled([fetchActivity(), fetchNotifications(), fetchCalendar()]);
}

async function refreshSystem() {
  await Promise.allSettled([fetchForge(), fetchStats()]);
}

async function refreshAll() {
  updateTimestamp();
  await Promise.allSettled([
    refreshMetrics(),
    refreshCharts(),
    refreshActivity(),
    refreshSystem(),
  ]);
}

// ===== Demo / Fallback Data =====
// When API is offline, populate with realistic demo data so the UI is not empty
function populateDemoData() {
  // Revenue
  animateValue($('#revToday'), 247.83, '$', '', 900);
  $('#revChange').className = 'metric-change up';
  $('#revChange').textContent = '+12.4%';
  drawSparkLine('revSpark', [180,195,210,190,220,235,205,215,240,248]);

  // Posts
  animateValue($('#postsWeek'), 34, '', '', 700);
  $('#postsChange').className = 'metric-change up';
  $('#postsChange').textContent = '+6 vs last week';

  // Tasks
  animateValue($('#activeTasks'), 3, '', '', 500);
  $('#nextTask').textContent = 'Next: content-publish at 14:30';
  $('#nextTask').className = 'metric-change flat';

  // Site Health
  const demoSites = SITES.map(s => ({
    id: s.id, domain: s.domain, status: Math.random() > 0.1 ? 'online' : 'offline',
    posts_week: Math.floor(Math.random() * (s.freq === 'daily' ? 7 : s.freq === '3x/wk' ? 4 : 3)),
    last_published: new Date(Date.now() - Math.random() * 7 * 86400000).toISOString(),
    seo_score: Math.floor(Math.random() * 30 + 65)
  }));
  renderSiteHealth(demoSites);
  renderVelocityChart(demoSites);
  renderContentGaps(demoSites);

  // Revenue Chart (demo)
  const demoRevDays = [];
  for (let i = 29; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    demoRevDays.push({ date: d.toISOString(), total: Math.random() * 150 + 100 });
  }

  const ctx = document.getElementById('revenueChart').getContext('2d');
  const gradient = ctx.createLinearGradient(0, 0, 0, 200);
  gradient.addColorStop(0, 'rgba(99,102,241,0.3)');
  gradient.addColorStop(1, 'rgba(99,102,241,0)');

  if (state.charts.revenue) state.charts.revenue.destroy();
  state.charts.revenue = new Chart(ctx, {
    type: 'line',
    data: {
      labels: demoRevDays.map(d => new Date(d.date).toLocaleDateString('en-US',{month:'short',day:'numeric'})),
      datasets: [{
        label: 'Revenue', data: demoRevDays.map(d => d.total),
        borderColor: '#6366f1', backgroundColor: gradient, fill: true,
        tension: 0.4, borderWidth: 2, pointRadius: 0
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false },
        tooltip: { backgroundColor: '#12121a', borderColor: '#1e1e2e', borderWidth: 1,
          titleColor: '#e2e8f0', bodyColor: '#94a3b8',
          bodyFont: { family: "'JetBrains Mono', monospace" },
          callbacks: { label: ctx => fmt$(ctx.parsed.y) }
        }
      },
      scales: {
        x: { grid: { color: 'rgba(30,30,46,0.5)' }, ticks: { color: '#475569', font: { size: 10 }, maxTicksLimit: 10 } },
        y: { grid: { color: 'rgba(30,30,46,0.5)' }, ticks: { color: '#475569', font: { family: "'JetBrains Mono', monospace", size: 10 }, callback: v => '$' + Math.round(v) } }
      }
    }
  });

  // Scheduler
  const demoJobs = [
    { name: 'content-pipeline', next_run: new Date(Date.now()+3600000).toISOString(), last_result: 'success' },
    { name: 'seo-audit', next_run: new Date(Date.now()+7200000).toISOString(), last_result: 'success' },
    { name: 'revenue-sync', next_run: new Date(Date.now()+10800000).toISOString(), last_result: 'success' },
    { name: 'site-monitor', next_run: new Date(Date.now()+14400000).toISOString(), last_result: 'pending' },
    { name: 'backup-weekly', next_run: new Date(Date.now()+86400000).toISOString(), last_result: 'success' },
  ];
  $('#schedList').innerHTML = demoJobs.map(j => {
    const statusClass = j.last_result === 'success' ? 'ok' : j.last_result === 'failed' ? 'failed' : 'pending';
    return `<li class="sched-item">
      <div><div class="sched-name">${j.name}</div><div class="sched-next">${fmtTime(j.next_run)}</div></div>
      <span class="sched-status ${statusClass}">${j.last_result}</span>
    </li>`;
  }).join('');

  // FORGE
  animateValue($('#forgeTasks'), 142, '', '', 600);
  animateValue($('#forgeSuccess'), 94, '', '%', 600);
  $('#forgeApps').textContent = '12';
  animateValue($('#forgeCodex'), 2847, '', '', 600);
  $('#forgeProgress').textContent = '94%';
  $('#forgeBarFill').style.width = '94%';
  $('#forgeBarFill').style.background = 'var(--success)';

  // Activity
  const demoEvents = [
    { type:'publish', message:'Published "Full Moon Ritual Guide"', site:'witchcraft', time: new Date(Date.now()-300000).toISOString(), status:'ok' },
    { type:'task', message:'SEO audit completed for all sites', site:null, time: new Date(Date.now()-1800000).toISOString(), status:'ok' },
    { type:'publish', message:'Published "Smart Thermostat Setup"', site:'smarthome', time: new Date(Date.now()-3600000).toISOString(), status:'ok' },
    { type:'alert', message:'LiteSpeed cache cleared', site:'aiaction', time: new Date(Date.now()-5400000).toISOString(), status:'ok' },
    { type:'publish', message:'Published "Crystal Grid Basics"', site:'crystalwitchcraft', time: new Date(Date.now()-7200000).toISOString(), status:'ok' },
    { type:'task', message:'Revenue sync completed', site:null, time: new Date(Date.now()-9000000).toISOString(), status:'ok' },
    { type:'publish', message:'Published "AI Trading Bots Review"', site:'wealthai', time: new Date(Date.now()-10800000).toISOString(), status:'ok' },
    { type:'alert', message:'High traffic detected on witchcraftforbeginners.com', site:'witchcraft', time: new Date(Date.now()-14400000).toISOString(), status:'ok' },
    { type:'publish', message:'Published "Tarot Spread for Love"', site:'tarotbeginners', time: new Date(Date.now()-18000000).toISOString(), status:'ok' },
    { type:'task', message:'Image pipeline generated 12 featured images', site:null, time: new Date(Date.now()-21600000).toISOString(), status:'ok' },
  ];
  $('#activityFeed').innerHTML = demoEvents.map(ev => {
    const dotColor = ev.type === 'publish' ? 'var(--success)' : ev.type === 'alert' ? 'var(--warning)' : 'var(--primary)';
    const siteTag = ev.site ? `<span class="feed-site">${ev.site}</span> ` : '';
    return `<li class="feed-item">
      <span class="feed-dot" style="background:${dotColor};"></span>
      <span class="feed-text">${siteTag}${ev.message}</span>
      <span class="feed-time">${relTime(ev.time)}</span>
    </li>`;
  }).join('');

  // Notifications
  const demoNotifs = [
    { severity:'success', title:'Content Pipeline Complete', body:'All 16 sites have been updated today.', time: new Date(Date.now()-1200000).toISOString(), unread:true },
    { severity:'warning', title:'Publishing Below Target', body:'herbalwitchery.com has only 1 post this week (target: 2).', time: new Date(Date.now()-7200000).toISOString(), unread:true },
    { severity:'info', title:'Revenue Milestone', body:'Daily revenue exceeded $200 for the 5th consecutive day.', time: new Date(Date.now()-14400000).toISOString(), unread:false },
    { severity:'critical', title:'SSL Expiring Soon', body:'moonphasewitch.com SSL expires in 14 days.', time: new Date(Date.now()-28800000).toISOString(), unread:true },
  ];
  state.unreadNotifs = demoNotifs.filter(n => n.unread).length;
  const badge = $('#notifBadge');
  badge.style.display = 'flex';
  badge.textContent = state.unreadNotifs;

  $('#notifList').innerHTML = demoNotifs.map(n => `<li class="notif-item ${n.severity} ${n.unread ? 'unread' : ''}">
    <div class="notif-header">
      <span class="notif-title">${n.title}</span>
      <span class="notif-time">${relTime(n.time)}</span>
    </div>
    <div class="notif-body">${n.body}</div>
  </li>`).join('');

  // Calendar
  const today = new Date();
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const calDays = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(today); d.setDate(d.getDate() + i);
    const ct = Math.floor(Math.random() * 5);
    calDays.push({ date: d, count: ct, isToday: i === 0 });
  }

  const demoCalPosts = [
    { title: 'Moon Phase Gardening Guide', date: new Date(Date.now() + 86400000).toISOString() },
    { title: 'Smart Lock Comparison 2026', date: new Date(Date.now() + 86400000).toISOString() },
    { title: 'AI Image Generator Roundup', date: new Date(Date.now() + 172800000).toISOString() },
    { title: 'Imbolc Ritual for Beginners', date: new Date(Date.now() + 259200000).toISOString() },
    { title: 'Bullet Journal Weekly Spread', date: new Date(Date.now() + 345600000).toISOString() },
  ];

  $('#calendarBody').innerHTML = `
    <div class="cal-days">
      ${calDays.map(d => {
        const cls = ['cal-day', d.isToday ? 'today' : '', d.count > 0 ? 'has-posts' : '', d.count >= 3 ? 'many-posts' : ''].filter(Boolean).join(' ');
        return `<div class="${cls}" title="${d.count} post(s) scheduled">
          <div class="cal-day-label">${dayNames[d.date.getDay()]}</div>
          <div>${d.date.getDate()}</div>
          ${d.count > 0 ? `<div class="cal-post-count">${d.count}</div>` : ''}
        </div>`;
      }).join('')}
    </div>
    <div style="margin-top:0.75rem;font-size:0.78rem;color:var(--text-secondary);">
      ${demoCalPosts.map(p => `<div style="padding:0.25rem 0;border-bottom:1px solid rgba(30,30,46,0.5);">
        <span style="color:var(--text);font-weight:500;">${p.title}</span>
        <span style="float:right;font-family:var(--mono);font-size:0.7rem;">${fmtDate(p.date)}</span>
      </div>`).join('')}
    </div>
  `;
}

// ===== Initialization =====
async function init() {
  updateTimestamp();

  // Try to connect to API
  try {
    await apiCall('/health');
    setOnline(true);
    await refreshAll();
  } catch (e) {
    setOnline(false);
    // Populate demo data so the dashboard is not blank
    populateDemoData();
  }

  // Auto-refresh timers
  setInterval(refreshMetrics, 30000);     // Health/metrics: 30s
  setInterval(refreshCharts, 300000);     // Charts: 5min
  setInterval(refreshActivity, 60000);    // Activity: 60s
  setInterval(refreshSystem, 120000);     // FORGE/stats: 2min
}

// Start
init();
</script>
</body>
</html>
